---
- name: Intializing Kubernetes Cluster
  command: kubeadm init --pod-network-cidr=192.168.0.0/16 --cri-socket="unix:///var/run/crio/crio.sock"
- pause: seconds=30
- name: Create directory for kube config
  file: 
    path: /home/root/.kube
    state: directory
    owner: root
    group: root
    mode: 0755
- name: Copy /etc/kubernetes/admin.conf to user home directory /home/root/.kube/config
  copy:
    src: /etc/kubernetes/admin.conf
    dest: /home/root/.kube/config
    remote_src: yes
    owner: root
    group: root
    mode: '0644'
- pause: seconds=10
- name: Remove the cache directory
  file: 
    path: /home/root/.kube/cache
    state: absent
- name: Install calico
  command: "kubectl apply -f https://docs.projectcalico.org/{{ calico_version }}/manifests/calico.yaml"
- pause: seconds=30
- name: Get the token for joining the nodes with Kuberentes master
  shell: kubeadm token create --print-join-command
  register: kubernetes_join_command
- debug:
    msg: "{{ kubernetes_join_command.stdout }}"
- name: Copy join command to local file
  become: false
  local_action: copy content="{{ kubernetes_join_command.stdout_lines[0] }}" dest="kubernetes_join_command" mode=0555
